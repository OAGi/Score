import { Subject, BehaviorSubject, delay, filter, tap } from 'rxjs';
import { Settings } from './utils';
export class TableData {
    // TODO refactor
    constructor(columns, options) {
        this._nextObservable = new Subject();
        this._previousObservable = new Subject();
        this._sizeObservable = new Subject();
        this._sortObservable = new Subject();
        this._sortHeadersObservable = new Subject();
        this._columns = new BehaviorSubject(columns.map(c => { if (c.isActive === undefined) {
            c.isActive = true;
        } return c; }));
        this._displayedColumns = this._columns.value.filter(c => c.isActive).map(c => c.id);
        if (options) {
            if (options.pageSizeOptions && options.pageSizeOptions.length < 1) {
                throw Error('Array of pageSizeOptions must contain at least one entry');
            }
            if (options.defaultSortParams) {
                options.defaultSortParams.map(s => {
                    if (!this._displayedColumns.includes(s)) {
                        throw Error(`Provided sort parameter "${s}" is not a column.`);
                    }
                });
            }
            this._sortParams = options.defaultSortParams || [];
            this._sortDirs = options.defaultSortDirs || [];
            if (this._sortParams.length !== this._sortDirs.length) {
                this._sortDirs = this._sortParams.map(() => 'asc');
            }
            this._totalElements = options.totalElements || 0;
            this._pageSizeOptions = options.pageSizeOptions || [10, 20, 50, 100];
            this._key = options.localStorageKey;
        }
        else {
            this._pageSizeOptions = [10, 20, 50, 100];
            this._sortParams = [];
            this._sortDirs = [];
        }
        this.init();
    }
    onSortEvent() {
        this._sortParams = this._dataSource.sort['actives'];
        this._sortDirs = this._dataSource.sort['directions'];
        this._clientSideSort();
        this._sortObservable.next();
        this.storeTableSettings();
    }
    onPaginationEvent($event) {
        const tmpPageSize = this.pageSize;
        this.pageSize = $event.pageSize;
        this.pageIndex = $event.pageIndex;
        if (tmpPageSize !== this.pageSize) {
            this._sizeObservable.next();
        }
        else if ($event.previousPageIndex && $event.previousPageIndex < $event.pageIndex) {
            this._nextObservable.next();
        }
        else if ($event.previousPageIndex && $event.previousPageIndex > $event.pageIndex) {
            this._previousObservable.next();
        }
    }
    updateSortHeaders() {
        // Dirty hack to display default sort column(s)
        const temp = Object.assign([], this._displayedColumns);
        this._sortHeadersObservable.next([]);
        this._sortHeadersObservable.next(temp);
        this._clientSideSort();
        this._sortObservable.next();
        this.storeTableSettings();
        1;
    }
    // this fixes an infine loop of rerendering
    subscribeSortHeaders() {
        this._sortHeadersObservable.pipe(delay(0), 
        // ignore when there is no update in the sort (params or dirs)
        filter(() => this._displayedSortDirs !== this.sortDirs && this._displayedSortParams !== this.sortParams), tap((column) => {
            // update the displayed sort when it is not the empty array
            if (column.length > 0) {
                this._displayedSortDirs = this.sortDirs;
                this._displayedSortParams = this.sortParams;
            }
        })).subscribe(columns => this._displayedColumns = columns);
    }
    init() {
        this.subscribeSortHeaders();
        if (this._key) {
            const settings = new Settings(this._key);
            settings.load();
            if (this._isLocalStorageSettingsValid(settings)) {
                this.columns = settings.columns;
                this._sortDirs = settings.sortDirs;
                this._sortParams = settings.sortParams;
            }
            else {
                console.warn("Stored tableSettings are invalid. Using default");
            }
        }
    }
    _clientSideSort() {
        this._dataSource.orderData();
    }
    _isLocalStorageSettingsValid(settings) {
        // check if number of columns matching
        if (settings.columns.length !== this._columns.value.length) {
            return false;
        }
        // check if columns are the same
        for (var column of settings.columns) {
            var match = this._columns.value.filter(c => c.id == column.id && c.name == column.name);
            if (match === undefined) {
                return false;
            }
        }
        return true;
    }
    storeTableSettings() {
        console.log("Store");
        if (this._key) {
            const settings = new Settings(this._key);
            settings.columns = this._columns.value;
            settings.sortParams = this._sortParams;
            settings.sortDirs = this._sortDirs;
            settings.save();
        }
    }
    set totalElements(totalElements) {
        this._totalElements = totalElements;
    }
    get totalElements() {
        return this._totalElements;
    }
    set displayedColumns(displayedColumns) {
        this._displayedColumns = displayedColumns;
        this._columns.next(this._columns.value.map(c => {
            if (this._displayedColumns.includes(c.id)) {
                c.isActive = true;
            }
            else
                c.isActive = false;
            return c;
        }));
    }
    get displayedColumns() {
        return this._displayedColumns;
    }
    set dataSource(dataSource) {
        this._dataSource = dataSource;
        if (this._sortParams.length > 0) {
            this._dataSource.sort.actives = this._sortParams;
            this._dataSource.sort.directions = this._sortDirs.map(v => v);
            this.updateSortHeaders();
        }
    }
    get dataSource() {
        return this._dataSource;
    }
    set data(data) {
        this._dataSource.data = data;
        this._clientSideSort();
    }
    set columns(v) {
        this._columns.next(v.map(c => { if (c.isActive === undefined) {
            c.isActive = true;
        } return c; }));
    }
    onColumnsChange() {
        return this._columns;
    }
    updateColumnNames(v) {
        const dict = {};
        v.forEach(c => dict[c.id] = c.name);
        this._columns.next(this._columns.value.map(c => { c.name = dict[c.id] || c.name; return c; }));
    }
    get nextObservable() {
        return this._nextObservable;
    }
    get previousObservable() {
        return this._previousObservable;
    }
    get sizeObservable() {
        return this._sizeObservable;
    }
    get sortObservable() {
        return this._sortObservable;
    }
    get sortParams() {
        return this._sortParams;
    }
    get sortDirs() {
        return this._sortDirs;
    }
    get columns() {
        return this._columns.value;
    }
    get pageSizeOptions() {
        return this._pageSizeOptions;
    }
    set sortParams(v) {
        this._sortParams = v;
        this._dataSource.sort.actives = this._sortParams;
    }
    set sortDirs(v) {
        this._sortDirs = v;
        this._dataSource.sort.directions = this._sortDirs.map(elem => elem);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL21hdC1tdWx0aS1zb3J0L3NyYy9saWIvdGFibGUtZGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUdwRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBR25DLE1BQU0sT0FBTyxTQUFTO0lBcUJsQixnQkFBZ0I7SUFDaEIsWUFBWSxPQUEyRCxFQUNuRSxPQU1DO1FBakJHLG9CQUFlLEdBQWtCLElBQUksT0FBTyxFQUFRLENBQUM7UUFDckQsd0JBQW1CLEdBQWtCLElBQUksT0FBTyxFQUFRLENBQUM7UUFDekQsb0JBQWUsR0FBa0IsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNyRCxvQkFBZSxHQUFrQixJQUFJLE9BQU8sRUFBUSxDQUFDO1FBSXJELDJCQUFzQixHQUFzQixJQUFJLE9BQU8sRUFBWSxDQUFDO1FBV3hFLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxlQUFlLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQUU7WUFBRSxDQUFDLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztTQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFILElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRXBGLElB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RCxJQUFXLFFBQVEsQ0FBQyxDQUFXO1FBQzNCLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQXFCLENBQUMsQ0FBQztJQUN6RixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0LCBCZWhhdmlvclN1YmplY3QsIGRlbGF5LCBmaWx0ZXIsIHRhcCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTWF0TXVsdGlTb3J0VGFibGVEYXRhU291cmNlIH0gZnJvbSAnLi9tYXQtbXVsdGktc29ydC1kYXRhLXNvdXJjZSc7XG5pbXBvcnQgeyBTb3J0RGlyZWN0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvc29ydCc7XG5pbXBvcnQgeyBTZXR0aW5ncyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgUGFnZUV2ZW50IH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvcGFnaW5hdG9yJztcblxuZXhwb3J0IGNsYXNzIFRhYmxlRGF0YTxUPiB7XG4gICAgcHJpdmF0ZSBfZGF0YVNvdXJjZSE6IE1hdE11bHRpU29ydFRhYmxlRGF0YVNvdXJjZTxUPjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9jb2x1bW5zOiBCZWhhdmlvclN1YmplY3Q8eyBpZDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGlzQWN0aXZlPzogYm9vbGVhbiB9W10+O1xuICAgIHByaXZhdGUgX2Rpc3BsYXllZENvbHVtbnM6IHN0cmluZ1tdO1xuICAgIHBhZ2VTaXplITogbnVtYmVyO1xuICAgIHBhZ2VJbmRleCE6IG51bWJlcjtcbiAgICBwcml2YXRlIF9wYWdlU2l6ZU9wdGlvbnM6IG51bWJlcltdO1xuICAgIHByaXZhdGUgX3RvdGFsRWxlbWVudHMhOiBudW1iZXI7XG4gICAgcHJpdmF0ZSBfc29ydFBhcmFtczogc3RyaW5nW107XG4gICAgcHJpdmF0ZSBfc29ydERpcnM6IHN0cmluZ1tdO1xuICAgIHByaXZhdGUgX2tleSE6IHN0cmluZztcblxuICAgIHByaXZhdGUgX25leHRPYnNlcnZhYmxlOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgICBwcml2YXRlIF9wcmV2aW91c09ic2VydmFibGU6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICAgIHByaXZhdGUgX3NpemVPYnNlcnZhYmxlOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgICBwcml2YXRlIF9zb3J0T2JzZXJ2YWJsZTogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gICAgcHJpdmF0ZSBfZGlzcGxheWVkU29ydERpcnM/OiBzdHJpbmdbXVxuICAgIHByaXZhdGUgX2Rpc3BsYXllZFNvcnRQYXJhbXM/OiBzdHJpbmdbXVxuXG4gICAgcHJpdmF0ZSBfc29ydEhlYWRlcnNPYnNlcnZhYmxlOiBTdWJqZWN0PHN0cmluZ1tdPiA9IG5ldyBTdWJqZWN0PHN0cmluZ1tdPigpO1xuXG4gICAgLy8gVE9ETyByZWZhY3RvclxuICAgIGNvbnN0cnVjdG9yKGNvbHVtbnM6IHsgaWQ6IHN0cmluZywgbmFtZTogc3RyaW5nLCBpc0FjdGl2ZT86IGJvb2xlYW4gfVtdLFxuICAgICAgICBvcHRpb25zPzoge1xuICAgICAgICAgICAgZGVmYXVsdFNvcnRQYXJhbXM/OiBzdHJpbmdbXSxcbiAgICAgICAgICAgIGRlZmF1bHRTb3J0RGlycz86IHN0cmluZ1tdLFxuICAgICAgICAgICAgcGFnZVNpemVPcHRpb25zPzogbnVtYmVyW10sXG4gICAgICAgICAgICB0b3RhbEVsZW1lbnRzPzogbnVtYmVyLFxuICAgICAgICAgICAgbG9jYWxTdG9yYWdlS2V5Pzogc3RyaW5nXG4gICAgICAgIH0pIHtcbiAgICAgICAgdGhpcy5fY29sdW1ucyA9IG5ldyBCZWhhdmlvclN1YmplY3QoY29sdW1ucy5tYXAoYyA9PiB7IGlmIChjLmlzQWN0aXZlID09PSB1bmRlZmluZWQpIHsgYy5pc0FjdGl2ZSA9IHRydWU7IH0gcmV0dXJuIGM7IH0pKTtcbiAgICAgICAgdGhpcy5fZGlzcGxheWVkQ29sdW1ucyA9IHRoaXMuX2NvbHVtbnMudmFsdWUuZmlsdGVyKGMgPT4gYy5pc0FjdGl2ZSkubWFwKGMgPT4gYy5pZCk7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhZ2VTaXplT3B0aW9ucyAmJiBvcHRpb25zLnBhZ2VTaXplT3B0aW9ucy5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0FycmF5IG9mIHBhZ2VTaXplT3B0aW9ucyBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIGVudHJ5Jyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRTb3J0UGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5kZWZhdWx0U29ydFBhcmFtcy5tYXAocyA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fZGlzcGxheWVkQ29sdW1ucy5pbmNsdWRlcyhzKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoYFByb3ZpZGVkIHNvcnQgcGFyYW1ldGVyIFwiJHtzfVwiIGlzIG5vdCBhIGNvbHVtbi5gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLl9zb3J0UGFyYW1zID0gb3B0aW9ucy5kZWZhdWx0U29ydFBhcmFtcyB8fCBbXTtcbiAgICAgICAgICAgIHRoaXMuX3NvcnREaXJzID0gb3B0aW9ucy5kZWZhdWx0U29ydERpcnMgfHwgW107XG5cbiAgICAgICAgICAgIGlmICh0aGlzLl9zb3J0UGFyYW1zLmxlbmd0aCAhPT0gdGhpcy5fc29ydERpcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc29ydERpcnMgPSB0aGlzLl9zb3J0UGFyYW1zLm1hcCgoKSA9PiAnYXNjJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuX3RvdGFsRWxlbWVudHMgPSBvcHRpb25zLnRvdGFsRWxlbWVudHMgfHwgMDtcbiAgICAgICAgICAgIHRoaXMuX3BhZ2VTaXplT3B0aW9ucyA9IG9wdGlvbnMucGFnZVNpemVPcHRpb25zIHx8IFsxMCwgMjAsIDUwLCAxMDBdO1xuICAgICAgICAgICAgdGhpcy5fa2V5ID0gb3B0aW9ucy5sb2NhbFN0b3JhZ2VLZXkhO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fcGFnZVNpemVPcHRpb25zID0gWzEwLCAyMCwgNTAsIDEwMF07XG4gICAgICAgICAgICB0aGlzLl9zb3J0UGFyYW1zID0gW107XG4gICAgICAgICAgICB0aGlzLl9zb3J0RGlycyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaW5pdCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblNvcnRFdmVudCgpIHtcbiAgICAgICAgdGhpcy5fc29ydFBhcmFtcyA9IHRoaXMuX2RhdGFTb3VyY2Uuc29ydFsnYWN0aXZlcyddO1xuICAgICAgICB0aGlzLl9zb3J0RGlycyA9IHRoaXMuX2RhdGFTb3VyY2Uuc29ydFsnZGlyZWN0aW9ucyddO1xuICAgICAgICB0aGlzLl9jbGllbnRTaWRlU29ydCgpO1xuICAgICAgICB0aGlzLl9zb3J0T2JzZXJ2YWJsZS5uZXh0KCk7XG4gICAgICAgIHRoaXMuc3RvcmVUYWJsZVNldHRpbmdzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uUGFnaW5hdGlvbkV2ZW50KCRldmVudDogUGFnZUV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHRtcFBhZ2VTaXplOiBudW1iZXIgPSB0aGlzLnBhZ2VTaXplO1xuICAgICAgICB0aGlzLnBhZ2VTaXplID0gJGV2ZW50LnBhZ2VTaXplO1xuICAgICAgICB0aGlzLnBhZ2VJbmRleCA9ICRldmVudC5wYWdlSW5kZXg7XG5cbiAgICAgICAgaWYgKHRtcFBhZ2VTaXplICE9PSB0aGlzLnBhZ2VTaXplKSB7XG4gICAgICAgICAgICB0aGlzLl9zaXplT2JzZXJ2YWJsZS5uZXh0KCk7XG4gICAgICAgIH0gZWxzZSBpZiAoJGV2ZW50LnByZXZpb3VzUGFnZUluZGV4ICYmICRldmVudC5wcmV2aW91c1BhZ2VJbmRleCA8ICRldmVudC5wYWdlSW5kZXgpIHtcbiAgICAgICAgICAgIHRoaXMuX25leHRPYnNlcnZhYmxlLm5leHQoKTtcbiAgICAgICAgfSBlbHNlIGlmICgkZXZlbnQucHJldmlvdXNQYWdlSW5kZXggJiYgJGV2ZW50LnByZXZpb3VzUGFnZUluZGV4ID4gJGV2ZW50LnBhZ2VJbmRleCkge1xuICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNPYnNlcnZhYmxlLm5leHQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVTb3J0SGVhZGVycygpOiB2b2lkIHtcbiAgICAgICAgLy8gRGlydHkgaGFjayB0byBkaXNwbGF5IGRlZmF1bHQgc29ydCBjb2x1bW4ocylcbiAgICAgICAgY29uc3QgdGVtcCA9IE9iamVjdC5hc3NpZ24oW10sIHRoaXMuX2Rpc3BsYXllZENvbHVtbnMpO1xuICAgICAgICB0aGlzLl9zb3J0SGVhZGVyc09ic2VydmFibGUubmV4dChbXSk7XG4gICAgICAgIHRoaXMuX3NvcnRIZWFkZXJzT2JzZXJ2YWJsZS5uZXh0KHRlbXApO1xuICAgICAgICB0aGlzLl9jbGllbnRTaWRlU29ydCgpO1xuICAgICAgICB0aGlzLl9zb3J0T2JzZXJ2YWJsZS5uZXh0KCk7XG4gICAgICAgIHRoaXMuc3RvcmVUYWJsZVNldHRpbmdzKCk7MVxuICAgIH1cblxuICAgIC8vIHRoaXMgZml4ZXMgYW4gaW5maW5lIGxvb3Agb2YgcmVyZW5kZXJpbmdcbiAgICBwcml2YXRlIHN1YnNjcmliZVNvcnRIZWFkZXJzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLl9zb3J0SGVhZGVyc09ic2VydmFibGUucGlwZShcbiAgICAgICAgICAgIGRlbGF5KDApLFxuICAgICAgICAgICAgLy8gaWdub3JlIHdoZW4gdGhlcmUgaXMgbm8gdXBkYXRlIGluIHRoZSBzb3J0IChwYXJhbXMgb3IgZGlycylcbiAgICAgICAgICAgIGZpbHRlcigoKSA9PiB0aGlzLl9kaXNwbGF5ZWRTb3J0RGlycyAhPT0gdGhpcy5zb3J0RGlycyAmJiB0aGlzLl9kaXNwbGF5ZWRTb3J0UGFyYW1zICE9PSB0aGlzLnNvcnRQYXJhbXMpLFxuICAgICAgICAgICAgdGFwKChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIGRpc3BsYXllZCBzb3J0IHdoZW4gaXQgaXMgbm90IHRoZSBlbXB0eSBhcnJheVxuICAgICAgICAgICAgICAgIGlmKGNvbHVtbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2Rpc3BsYXllZFNvcnREaXJzID0gdGhpcy5zb3J0RGlycztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGlzcGxheWVkU29ydFBhcmFtcyA9IHRoaXMuc29ydFBhcmFtcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICApLnN1YnNjcmliZShjb2x1bW5zID0+IHRoaXMuX2Rpc3BsYXllZENvbHVtbnMgPSBjb2x1bW5zKVxuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdCgpIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpYmVTb3J0SGVhZGVycygpO1xuICAgICAgICBpZiAodGhpcy5fa2V5KSB7XG4gICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9IG5ldyBTZXR0aW5ncyh0aGlzLl9rZXkpO1xuICAgICAgICAgICAgc2V0dGluZ3MubG9hZCgpO1xuICAgICAgICAgICAgaWYgKHRoaXMuX2lzTG9jYWxTdG9yYWdlU2V0dGluZ3NWYWxpZChzZXR0aW5ncykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbnMgPSBzZXR0aW5ncy5jb2x1bW5zO1xuICAgICAgICAgICAgICAgIHRoaXMuX3NvcnREaXJzID0gc2V0dGluZ3Muc29ydERpcnM7XG4gICAgICAgICAgICAgICAgdGhpcy5fc29ydFBhcmFtcyA9IHNldHRpbmdzLnNvcnRQYXJhbXM7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcIlN0b3JlZCB0YWJsZVNldHRpbmdzIGFyZSBpbnZhbGlkLiBVc2luZyBkZWZhdWx0XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY2xpZW50U2lkZVNvcnQoKSB7XG4gICAgICAgIHRoaXMuX2RhdGFTb3VyY2Uub3JkZXJEYXRhKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaXNMb2NhbFN0b3JhZ2VTZXR0aW5nc1ZhbGlkKHNldHRpbmdzOiBTZXR0aW5ncyk6IGJvb2xlYW4ge1xuICAgICAgICAvLyBjaGVjayBpZiBudW1iZXIgb2YgY29sdW1ucyBtYXRjaGluZ1xuICAgICAgICBpZiAoc2V0dGluZ3MuY29sdW1ucy5sZW5ndGggIT09IHRoaXMuX2NvbHVtbnMudmFsdWUubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjaGVjayBpZiBjb2x1bW5zIGFyZSB0aGUgc2FtZVxuICAgICAgICBmb3IgKHZhciBjb2x1bW4gb2Ygc2V0dGluZ3MuY29sdW1ucykge1xuICAgICAgICAgICAgdmFyIG1hdGNoID0gdGhpcy5fY29sdW1ucy52YWx1ZS5maWx0ZXIoYyA9PiBjLmlkID09IGNvbHVtbi5pZCAmJiBjLm5hbWUgPT0gY29sdW1uLm5hbWUpO1xuICAgICAgICAgICAgaWYgKG1hdGNoID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHVibGljIHN0b3JlVGFibGVTZXR0aW5ncygpOiB2b2lkIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJTdG9yZVwiKVxuICAgICAgICBpZiAodGhpcy5fa2V5KSB7XG4gICAgICAgICAgICBjb25zdCBzZXR0aW5nczogU2V0dGluZ3MgPSBuZXcgU2V0dGluZ3ModGhpcy5fa2V5KTtcbiAgICAgICAgICAgIHNldHRpbmdzLmNvbHVtbnMgPSB0aGlzLl9jb2x1bW5zLnZhbHVlO1xuICAgICAgICAgICAgc2V0dGluZ3Muc29ydFBhcmFtcyA9IHRoaXMuX3NvcnRQYXJhbXM7XG4gICAgICAgICAgICBzZXR0aW5ncy5zb3J0RGlycyA9IHRoaXMuX3NvcnREaXJzO1xuICAgICAgICAgICAgc2V0dGluZ3Muc2F2ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHNldCB0b3RhbEVsZW1lbnRzKHRvdGFsRWxlbWVudHM6IG51bWJlcikge1xuICAgICAgICB0aGlzLl90b3RhbEVsZW1lbnRzID0gdG90YWxFbGVtZW50cztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHRvdGFsRWxlbWVudHMoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RvdGFsRWxlbWVudHM7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBkaXNwbGF5ZWRDb2x1bW5zKGRpc3BsYXllZENvbHVtbnM6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuX2Rpc3BsYXllZENvbHVtbnMgPSBkaXNwbGF5ZWRDb2x1bW5zO1xuICAgICAgICB0aGlzLl9jb2x1bW5zLm5leHQodGhpcy5fY29sdW1ucy52YWx1ZS5tYXAoYyA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5fZGlzcGxheWVkQ29sdW1ucy5pbmNsdWRlcyhjLmlkKSkge1xuICAgICAgICAgICAgICAgIGMuaXNBY3RpdmUgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIGMuaXNBY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybiBjO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBkaXNwbGF5ZWRDb2x1bW5zKCk6IHN0cmluZ1tdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Rpc3BsYXllZENvbHVtbnM7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBkYXRhU291cmNlKGRhdGFTb3VyY2U6IE1hdE11bHRpU29ydFRhYmxlRGF0YVNvdXJjZTxUPikge1xuICAgICAgICB0aGlzLl9kYXRhU291cmNlID0gZGF0YVNvdXJjZTtcbiAgICAgICAgaWYgKHRoaXMuX3NvcnRQYXJhbXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5fZGF0YVNvdXJjZS5zb3J0LmFjdGl2ZXMgPSB0aGlzLl9zb3J0UGFyYW1zO1xuICAgICAgICAgICAgdGhpcy5fZGF0YVNvdXJjZS5zb3J0LmRpcmVjdGlvbnMgPSB0aGlzLl9zb3J0RGlycy5tYXAodiA9PiB2IGFzIFNvcnREaXJlY3Rpb24pO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTb3J0SGVhZGVycygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBkYXRhU291cmNlKCk6IE1hdE11bHRpU29ydFRhYmxlRGF0YVNvdXJjZTxUPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kYXRhU291cmNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgZGF0YShkYXRhOiBUW10pIHtcbiAgICAgICAgdGhpcy5fZGF0YVNvdXJjZS5kYXRhID0gZGF0YTtcbiAgICAgICAgdGhpcy5fY2xpZW50U2lkZVNvcnQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IGNvbHVtbnModjogeyBpZDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGlzQWN0aXZlPzogYm9vbGVhbiB9W10pIHtcbiAgICAgICAgdGhpcy5fY29sdW1ucy5uZXh0KHYubWFwKGMgPT4geyBpZiAoYy5pc0FjdGl2ZSA9PT0gdW5kZWZpbmVkKSB7IGMuaXNBY3RpdmUgPSB0cnVlOyB9IHJldHVybiBjOyB9KSk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uQ29sdW1uc0NoYW5nZSgpOiBCZWhhdmlvclN1YmplY3Q8eyBpZDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGlzQWN0aXZlPzogYm9vbGVhbiB9W10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbHVtbnM7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZUNvbHVtbk5hbWVzKHY6IHsgaWQ6IHN0cmluZywgbmFtZTogc3RyaW5nIH1bXSkge1xuICAgICAgICBjb25zdCBkaWN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG4gICAgICAgIHYuZm9yRWFjaChjID0+IGRpY3RbYy5pZF0gPSBjLm5hbWUpO1xuICAgICAgICB0aGlzLl9jb2x1bW5zLm5leHQodGhpcy5fY29sdW1ucy52YWx1ZS5tYXAoYyA9PiB7IGMubmFtZSA9IGRpY3RbYy5pZF0gfHwgYy5uYW1lOyByZXR1cm4gYzsgfSkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgbmV4dE9ic2VydmFibGUoKTogU3ViamVjdDxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX25leHRPYnNlcnZhYmxlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcHJldmlvdXNPYnNlcnZhYmxlKCk6IFN1YmplY3Q8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c09ic2VydmFibGU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBzaXplT2JzZXJ2YWJsZSgpOiBTdWJqZWN0PGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2l6ZU9ic2VydmFibGU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBzb3J0T2JzZXJ2YWJsZSgpOiBTdWJqZWN0PGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fc29ydE9ic2VydmFibGU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBzb3J0UGFyYW1zKCk6IHN0cmluZ1tdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NvcnRQYXJhbXM7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBzb3J0RGlycygpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zb3J0RGlycztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGNvbHVtbnMoKTogeyBpZDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGlzQWN0aXZlPzogYm9vbGVhbiB9W10ge1xuICAgICAgICByZXR1cm4gdGhpcy5fY29sdW1ucy52YWx1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHBhZ2VTaXplT3B0aW9ucygpOiBudW1iZXJbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9wYWdlU2l6ZU9wdGlvbnM7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBzb3J0UGFyYW1zKHY6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuX3NvcnRQYXJhbXMgPSB2O1xuICAgICAgICB0aGlzLl9kYXRhU291cmNlLnNvcnQuYWN0aXZlcyA9IHRoaXMuX3NvcnRQYXJhbXM7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBzb3J0RGlycyh2OiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLl9zb3J0RGlycyA9IHY7XG4gICAgICAgIHRoaXMuX2RhdGFTb3VyY2Uuc29ydC5kaXJlY3Rpb25zID0gdGhpcy5fc29ydERpcnMubWFwKGVsZW0gPT4gZWxlbSBhcyBTb3J0RGlyZWN0aW9uKTtcbiAgICB9XG59XG4iXX0=